<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mafia Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body style="font-family: system-ui; padding: 16px; background:#f7f7f7;">
  <h2>üé≠ –ú–∞—Ñ–∏—è (v5)</h2>

  <div id="status" style="padding:12px; border-radius:10px; background:#fff; margin-bottom:12px;">
    –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶
  </div>

  <button id="join" style="padding:12px 16px; font-size:16px; width:100%; margin-bottom:8px;">
    ‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ
  </button>

  <button id="refresh" style="padding:12px 16px; font-size:16px; width:100%; margin-bottom:12px;">
    üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
  </button>

  <div style="padding:12px; border-radius:10px; background:#fff;">
    <b>–ò–≥—Ä–æ–∫–∏:</b>
    <div id="playersList" style="margin-top:8px; color:#444;">
      ‚Äî
    </div>
    <div id="debug" style="margin-top:10px; font-size:12px; color:#777;">
      debug: ‚Äî
    </div>
  </div>

  <script>
    const API_URL = "https://liplike-hominine-zara.ngrok-free.dev";

    const statusEl = document.getElementById("status");
    const joinBtn = document.getElementById("join");
    const refreshBtn = document.getElementById("refresh");
    const playersListEl = document.getElementById("playersList");
    const debugEl = document.getElementById("debug");

    const tg = window.Telegram?.WebApp;

    function setDebug(msg) {
      debugEl.textContent = "debug: " + msg;
    }

    // ‚úÖ –æ–¥–∏–Ω —Ä–∞–∑ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è ngrok
    const NGROK_HEADERS = { "ngrok-skip-browser-warning": "1" };

    if (!tg) {
      statusEl.innerHTML = "‚ùå –û—Ç–∫—Ä–æ–π —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ Telegram.";
      joinBtn.disabled = true;
      refreshBtn.disabled = true;
      setDebug("Telegram.WebApp is undefined");
    } else {
      tg.ready();
      tg.expand();

      const chatId = tg.initDataUnsafe?.start_param;
      const user = tg.initDataUnsafe?.user;

      statusEl.innerHTML = `
        <b>–ò–≥—Ä–∞:</b> ${chatId}<br/>
        <b>–í—ã:</b> ${user ? user.first_name : "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}<br/>
        <b>API:</b> ${API_URL}
      `;

      async function refreshPlayers() {
        try {
          if (!chatId) {
            playersListEl.innerHTML = "<i>chat_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω</i>";
            setDebug("no chatId");
            return;
          }

          playersListEl.innerHTML = "<i>–æ–±–Ω–æ–≤–ª—è—é...</i>";

          const u = new URL("/state", API_URL);
          u.searchParams.set("chat_id", String(chatId));

          setDebug("GET " + u.toString());

          // ‚úÖ –¥–æ–±–∞–≤–∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è ngrok
          const res = await fetch(u.toString(), {
            method: "GET",
            headers: NGROK_HEADERS
          });

          const text = await res.text();
          setDebug("state status=" + res.status + ", len=" + text.length);

          if (!res.ok) {
            playersListEl.innerHTML = "<b>‚ùå /state error</b><br/>" + text.slice(0, 200);
            return;
          }

          let data;
          try {
            data = JSON.parse(text);
          } catch (e) {
            playersListEl.innerHTML = "<b>‚ùå /state returned not JSON</b><br/>" + text.slice(0, 200);
            return;
          }

          if (!data.players || data.players.length === 0) {
            playersListEl.innerHTML = "<i>–Ω–∏–∫–æ–≥–æ –Ω–µ—Ç</i>";
            return;
          }

          playersListEl.innerHTML = data.players
            .map(p => `‚Ä¢ ${p.name}`)
            .join("<br/>");
        } catch (e) {
          playersListEl.innerHTML = "<b>‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</b>";
          setDebug("refresh error: " + e.message);
        }
      }

      joinBtn.onclick = async () => {
        try {
          if (!chatId) {
            alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–≥—Ä—É");
            return;
          }

          setDebug("POST /join ...");

          // ‚úÖ –¥–æ–±–∞–≤–∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è ngrok + Content-Type
          const res = await fetch(`${API_URL}/join`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "ngrok-skip-browser-warning": "1"
            },
            body: JSON.stringify({
              chat_id: Number(chatId),
              init_data: tg.initData
            })
          });

          setDebug("join status=" + res.status);

          if (!res.ok) {
            const t = await res.text();
            alert("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É: " + t.slice(0, 200));
            return;
          }

          await refreshPlayers();
          joinBtn.disabled = true;
          joinBtn.innerText = "‚úî –í—ã –≤ –∏–≥—Ä–µ";
        } catch (e) {
          setDebug("join error: " + e.message);
        }
      };

      refreshBtn.onclick = refreshPlayers;

      refreshPlayers();
    }
  </script>
</body>
</html>