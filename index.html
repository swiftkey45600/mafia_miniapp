<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mafia Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body style="font-family: system-ui; padding: 16px;">
  <h2>üé≠ –ú–∞—Ñ–∏—è ‚Äî Mini App</h2>

  <div id="info" style="padding:12px; border:1px solid #ddd; border-radius:10px;">
    –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶
  </div>

  <div style="height:12px"></div>

  <button id="join" style="padding:12px 16px; font-size:16px;">‚úÖ Join</button>

  <script>
    const API_URL = "https://liplike-hominine-zara.ngrok-free.dev";

    const infoEl = document.getElementById("info");
    const joinBtn = document.getElementById("join");

    function log(msg) {
      infoEl.innerHTML += "<div style='margin-top:6px;'>" + msg + "</div>";
    }

    // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∂–µ–º —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ
    infoEl.innerHTML = "<b>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:</b>";

    // –ü—Ä–æ–≤–µ—Ä–∫–∞: –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ª–∏ SDK –≤–æ–æ–±—â–µ
    log("SDK loaded: " + (typeof window.Telegram !== "undefined"));

    const tg = window.Telegram?.WebApp;
    if (!tg) {
      log("‚ùå Telegram.WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–∫—Ä–æ–π –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ Telegram (t.me/.../mafia123).");
      joinBtn.disabled = true;
    } else {
      try {
        tg.ready();
        tg.expand();

        const chatId = tg.initDataUnsafe?.start_param;
        const user = tg.initDataUnsafe?.user;

        log("chat_id: " + (chatId ?? "–Ω–µ—Ç"));
        log("user: " + (user ? (user.first_name + " (" + user.id + ")") : "–Ω–µ—Ç"));
        log("initData length: " + (tg.initData ? tg.initData.length : 0));
        log("API_URL: " + API_URL);

        joinBtn.onclick = async () => {
          try {
            if (!chatId) {
              alert("‚ùå chat_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω. –û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –≥—Ä—É–ø–ø–µ (/new).");
              return;
            }

            const res = await fetch(`${API_URL}/join`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                chat_id: Number(chatId),
                init_data: tg.initData
              })
            });

            const text = await res.text();
            log("POST /join status: " + res.status);

            if (!res.ok) {
              log("‚ùå Server error body: " + text);
              alert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –°–º–æ—Ç—Ä–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ.");
              return;
            }

            const data = JSON.parse(text);
            alert("‚úÖ –í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å! –ò–≥—Ä–æ–∫–æ–≤: " + data.players.length);
          } catch (e) {
            log("‚ùå Fetch exception: " + e.message);
            alert("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞. –°–º–æ—Ç—Ä–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ.");
          }
        };
      } catch (e) {
        log("‚ùå JS exception: " + e.message);
        joinBtn.disabled = true;
      }
    }
  </script>
</body>
</html>