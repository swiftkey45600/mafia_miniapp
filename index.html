<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Mafia Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0f14;color:#e6edf3}
.wrap{max-width:520px;margin:auto;padding:16px}
.card{background:#121826;border-radius:16px;padding:14px;margin-bottom:12px}
.btn{width:100%;padding:12px;border-radius:14px;border:none;font-weight:800;background:#1b2333;color:#e6edf3}
.btn.primary{background:#2f7dff}
.btn.danger{background:#e54848}
.btn[disabled]{opacity:.5}
.list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:12px;background:#1b2333}
.hidden{display:none}
.badge{padding:4px 10px;border-radius:999px;background:#1b2333;font-size:12px}
.small{font-size:12px;color:#9aa4b2}
.toast{position:fixed;bottom:20px;left:20px;right:20px;background:#121826;
border-radius:12px;padding:10px;text-align:center;display:none}
</style>
</head>

<body>
<div class="wrap">

<div class="card">
  <b>üé≠ Mafia</b>
  <div class="small" id="meLine">‚Äî</div>
  <div class="badge" id="phaseBadge">‚Äî</div>
  <div class="small" id="timerLine">‚Äî</div>
</div>

<div class="card">
  <button class="btn primary" id="joinBtn">Join</button>
  <button class="btn danger hidden" id="leaveBtn">Leave</button>
</div>

<div class="card hidden" id="roleCard">
  <button class="btn" id="roleBtn">–ú–æ—è —Ä–æ–ª—å</button>
</div>

<div class="card hidden" id="actionCard">
  <b id="actionTitle">–î–µ–π—Å—Ç–≤–∏–µ</b>
  <div class="list" id="actionList"></div>
</div>

<div class="card">
  <b>–ò–≥—Ä–æ–∫–∏</b>
  <div class="list" id="playersList"></div>
</div>

</div>

<div class="toast" id="toast"></div>

<script>
const API="https://liplike-hominine-zara.ngrok-free.dev";
const tg=window.Telegram.WebApp;
tg.ready();tg.expand();

const joinBtn=gid("joinBtn"),leaveBtn=gid("leaveBtn"),
roleBtn=gid("roleBtn"),roleCard=gid("roleCard"),
actionCard=gid("actionCard"),actionList=gid("actionList"),
playersList=gid("playersList"),toast=gid("toast"),
phaseBadge=gid("phaseBadge"),timerLine=gid("timerLine"),
meLine=gid("meLine"),actionTitle=gid("actionTitle");

let state=null,myId=tg.initDataUnsafe.user.id,chatId=tg.initDataUnsafe.start_param;
meLine.textContent=`–í—ã: ${tg.initDataUnsafe.user.first_name} (${myId})`;

function gid(id){return document.getElementById(id)}
function showToast(t){toast.textContent=t;toast.style.display="block";
setTimeout(()=>toast.style.display="none",1500)}

async function api(path,body){
const r=await fetch(API+path,{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify(body)});
if(!r.ok)throw await r.text();
return r.json()
}
async function apiGet(){
const r=await fetch(`${API}/state?chat_id=${chatId}`);
return r.json()
}

function render(){
if(!state)return;
phaseBadge.textContent=state.phase.toUpperCase();

if(state.phase_ends_at){
const t=Math.max(0,Math.floor(state.phase_ends_at-Date.now()/1000));
timerLine.textContent=`‚è≥ ${t}s`
}else timerLine.textContent="‚Äî";

const me=state.players.find(p=>p.id===myId);
const inGame=!!me;

joinBtn.classList.toggle("hidden",inGame);
leaveBtn.classList.toggle("hidden",!inGame);
roleCard.classList.toggle("hidden",!inGame);

playersList.innerHTML="";
state.players.forEach(p=>{
const el=document.createElement("div");
el.className="item";
el.innerHTML=`<div>${p.name}</div><div class="small">${p.alive?"üü¢":"üíÄ"}</div>`;
playersList.appendChild(el);
});

renderActions(me);
}

function renderActions(me){
actionList.innerHTML="";
actionCard.classList.add("hidden");
if(!me||!me.alive)return;

if(state.phase==="night"){
if(["mafia","don","doctor"].includes(me.role)){
actionCard.classList.remove("hidden");
actionTitle.textContent="üåô –ù–æ—á–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ";
state.players.filter(p=>p.alive&&p.id!==myId).forEach(p=>{
const b=document.createElement("button");
b.className="btn";
b.textContent=p.name;
b.onclick=async()=>{
await api("/night_action",{chat_id:chatId,init_data:tg.initData,target_id:p.id});
showToast("–í—ã–±–æ—Ä –ø—Ä–∏–Ω—è—Ç");
};
actionList.appendChild(b);
});
}
}

if(state.phase==="vote"){
actionCard.classList.remove("hidden");
actionTitle.textContent="üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ";
state.players.filter(p=>p.alive&&p.id!==myId).forEach(p=>{
const b=document.createElement("button");
b.className="btn";
b.textContent=p.name;
b.onclick=async()=>{
await api("/day_vote",{chat_id:chatId,init_data:tg.initData,target_id:p.id});
showToast("–ì–æ–ª–æ—Å –ø—Ä–∏–Ω—è—Ç");
};
actionList.appendChild(b);
});
}
}

joinBtn.onclick=async()=>{
state=await api("/join",{chat_id:chatId,init_data:tg.initData});
showToast("–í—ã –≤ –∏–≥—Ä–µ");
render();
};

leaveBtn.onclick=()=>location.reload();

roleBtn.onclick=()=>{
const me=state.players.find(p=>p.id===myId);
showToast(me?.role?`–í–∞—à–∞ —Ä–æ–ª—å: ${me.role}`:"–†–æ–ª—å –Ω–µ –≤—ã–¥–∞–Ω–∞");
};

async function refresh(){
state=await apiGet();
render();
}

setInterval(refresh,2000);
refresh();
</script>
</body>
</html>