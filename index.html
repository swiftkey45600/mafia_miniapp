<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mafia Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body style="font-family: system-ui; padding: 16px; background:#f7f7f7;">
  <h2>üé≠ –ú–∞—Ñ–∏—è (MVP)</h2>

  <div id="status" style="padding:12px; border-radius:10px; background:#fff; margin-bottom:12px;">
    –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶
  </div>

  <div style="display:flex; gap:8px; margin-bottom:12px;">
    <button id="join" style="flex:1; padding:12px 16px; font-size:16px;">‚úÖ Join</button>
    <button id="leave" style="flex:1; padding:12px 16px; font-size:16px;">üö™ Leave</button>
  </div>

  <div style="display:flex; gap:8px; margin-bottom:12px;">
    <button id="refresh" style="flex:1; padding:12px 16px; font-size:16px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    <button id="me" style="flex:1; padding:12px 16px; font-size:16px;">üïµÔ∏è –ú–æ—è —Ä–æ–ª—å</button>
  </div>

  <div id="hostPanel" style="padding:12px; border-radius:10px; background:#fff; margin-bottom:12px; display:none;">
    <b>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ç–æ–ª—å–∫–æ —Ö–æ—Å—Ç)</b>

    <div style="margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
      <label>
        –ú–∏–Ω. –∏–≥—Ä–æ–∫–æ–≤<br/>
        <input id="minPlayers" type="number" min="3" value="3" style="width:100%; padding:8px;">
      </label>

      <label>
        –ú–∞—Ñ–∏–π<br/>
        <input id="roleMafia" type="number" min="1" value="1" style="width:100%; padding:8px;">
      </label>

      <label>
        –î–æ–∫—Ç–æ—Ä–æ–≤<br/>
        <input id="roleDoctor" type="number" min="0" value="0" style="width:100%; padding:8px;">
      </label>

      <label>
        –®–µ—Ä–∏—Ñ–æ–≤<br/>
        <input id="roleSheriff" type="number" min="0" value="0" style="width:100%; padding:8px;">
      </label>

      <label>
        –î–µ–Ω—å (—Å–µ–∫)<br/>
        <input id="daySeconds" type="number" min="10" value="60" style="width:100%; padding:8px;">
      </label>

      <label>
        –ù–æ—á—å (—Å–µ–∫)<br/>
        <input id="nightSeconds" type="number" min="10" value="45" style="width:100%; padding:8px;">
      </label>
    </div>

    <div style="display:flex; gap:8px; margin-top:10px;">
      <button id="saveConfig" style="flex:1; padding:12px 16px; font-size:16px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="startGame" style="flex:1; padding:12px 16px; font-size:16px;">üöÄ Start</button>
    </div>

    <div id="hostHint" style="margin-top:10px; font-size:12px; color:#666;"></div>
  </div>

  <div style="padding:12px; border-radius:10px; background:#fff;">
    <b>–ò–≥—Ä–æ–∫–∏:</b>
    <div id="playersList" style="margin-top:8px; color:#444;">‚Äî</div>
    <div id="debug" style="margin-top:10px; font-size:12px; color:#777;">debug: ‚Äî</div>
  </div>

  <script>
    // ‚ö†Ô∏è –µ—Å–ª–∏ ngrok –ø–æ–º–µ–Ω—è–µ—Ç—Å—è ‚Äî –æ–±–Ω–æ–≤–∏ URL –∑–¥–µ—Å—å
    const API_URL = "https://liplike-hominine-zara.ngrok-free.dev";

    const statusEl = document.getElementById("status");
    const joinBtn = document.getElementById("join");
    const leaveBtn = document.getElementById("leave");
    const refreshBtn = document.getElementById("refresh");
    const meBtn = document.getElementById("me");

    const hostPanel = document.getElementById("hostPanel");
    const hostHint = document.getElementById("hostHint");
    const saveConfigBtn = document.getElementById("saveConfig");
    const startGameBtn = document.getElementById("startGame");

    const minPlayersEl = document.getElementById("minPlayers");
    const roleMafiaEl = document.getElementById("roleMafia");
    const roleDoctorEl = document.getElementById("roleDoctor");
    const roleSheriffEl = document.getElementById("roleSheriff");
    const daySecondsEl = document.getElementById("daySeconds");
    const nightSecondsEl = document.getElementById("nightSeconds");

    const playersListEl = document.getElementById("playersList");
    const debugEl = document.getElementById("debug");

    const tg = window.Telegram?.WebApp;

    const NGROK_HEADERS = { "ngrok-skip-browser-warning": "1" };

    function setDebug(msg) { debugEl.textContent = "debug: " + msg; }
    function phaseName(phase) {
      if (phase === "lobby") return "–õ–æ–±–±–∏";
      if (phase === "night") return "–ù–æ—á—å üåô";
      if (phase === "day") return "–î–µ–Ω—å ‚òÄÔ∏è";
      return phase ?? "‚Äî";
    }
    function fmtSeconds(s) {
      s = Math.max(0, s|0);
      const m = Math.floor(s/60);
      const r = s%60;
      return (m>0 ? m + ":" + String(r).padStart(2,"0") : String(r));
    }

    if (!tg) {
      statusEl.innerHTML = "‚ùå –û—Ç–∫—Ä–æ–π Mini App —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ Telegram.";
      joinBtn.disabled = true;
      leaveBtn.disabled = true;
      refreshBtn.disabled = true;
      meBtn.disabled = true;
      setDebug("Telegram.WebApp is undefined");
    } else {
      tg.ready();
      tg.expand();

      const chatId = tg.initDataUnsafe?.start_param;
      const meUser = tg.initDataUnsafe?.user;
      const myId = meUser?.id;

      statusEl.innerHTML = `<b>–ò–≥—Ä–∞:</b> ${chatId}<br/><b>–í—ã:</b> ${meUser ? meUser.first_name : "‚Äî"}<br/><b>API:</b> ${API_URL}`;

      let lastState = null;
      let timerInterval = null;

      async function apiGet(path, params={}) {
        const u = new URL(path, API_URL);
        for (const [k,v] of Object.entries(params)) u.searchParams.set(k, String(v));
        setDebug("GET " + u.toString());
        const res = await fetch(u.toString(), { method:"GET", headers: NGROK_HEADERS });
        const text = await res.text();
        if (!res.ok) throw new Error("HTTP " + res.status + ": " + text.slice(0,200));
        return JSON.parse(text);
      }

      async function apiPost(path, bodyObj) {
        const u = new URL(path, API_URL);
        setDebug("POST " + u.toString());
        const res = await fetch(u.toString(), {
          method:"POST",
          headers: { "Content-Type":"application/json", "ngrok-skip-browser-warning":"1" },
          body: JSON.stringify(bodyObj)
        });
        const text = await res.text();
        if (!res.ok) throw new Error("HTTP " + res.status + ": " + text.slice(0,200));
        return JSON.parse(text);
      }

      function renderState(state) {
        lastState = state;

        // players
        const players = state.players ?? [];
        if (players.length === 0) playersListEl.innerHTML = "<i>–Ω–∏–∫–æ–≥–æ –Ω–µ—Ç</i>";
        else playersListEl.innerHTML = players.map(p => `‚Ä¢ ${p.name}`).join("<br/>");

        // host
        const isHost = (state.host_id && myId && state.host_id === myId);
        hostPanel.style.display = isHost ? "block" : "none";

        // config -> inputs
        const cfg = state.config;
        if (cfg) {
          minPlayersEl.value = cfg.min_players;
          roleMafiaEl.value = cfg.roles.mafia;
          roleDoctorEl.value = cfg.roles.doctor;
          roleSheriffEl.value = cfg.roles.sheriff;
          daySecondsEl.value = cfg.day_seconds;
          nightSecondsEl.value = cfg.night_seconds;
        }

        // phase + timer
        const phase = state.phase;
        const endsAt = state.phase_ends_at;
        const left = endsAt ? Math.max(0, Math.floor(endsAt*1000 - Date.now())/1000) : 0;

        // start availability hint
        if (isHost) {
          const rolesTotal = (Number(roleMafiaEl.value)||0)+(Number(roleDoctorEl.value)||0)+(Number(roleSheriffEl.value)||0);
          hostHint.textContent =
            `–ò–≥—Ä–æ–∫–æ–≤: ${players.length}. –†–æ–ª–µ–π: ${rolesTotal}. –§–∞–∑–∞: ${phaseName(phase)}.`;
        }

        // update status block
        statusEl.innerHTML = `
          <b>–ò–≥—Ä–∞:</b> ${state.chat_id}<br/>
          <b>–í—ã:</b> ${meUser ? meUser.first_name : "‚Äî"}<br/>
          <b>–§–∞–∑–∞:</b> ${phaseName(phase)} ${endsAt ? `(–¥–æ –∫–æ–Ω—Ü–∞: <span id="tleft">${fmtSeconds(left)}</span>)` : ""}<br/>
          <b>–•–æ—Å—Ç:</b> ${state.host_id ?? "‚Äî"}
        `;

        // timer ticker
        if (timerInterval) clearInterval(timerInterval);
        if (endsAt) {
          const tleftEl = document.getElementById("tleft");
          timerInterval = setInterval(() => {
            const sec = Math.max(0, Math.floor(endsAt*1000 - Date.now())/1000);
            if (tleftEl) tleftEl.textContent = fmtSeconds(sec);
            if (sec <= 0) refreshState(); // —Ñ–∞–∑–∞ –¥–æ–ª–∂–Ω–∞ —Å–º–µ–Ω–∏—Ç—å—Å—è
          }, 500);
        }
      }

      async function refreshState() {
        if (!chatId) return;
        try {
          const state = await apiGet("/state", { chat_id: chatId });
          renderState(state);
        } catch (e) {
          playersListEl.innerHTML = "<b>‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</b>";
          setDebug("refresh error: " + e.message);
        }
      }

      joinBtn.onclick = async () => {
        try {
          if (!chatId) return alert("‚ùå chat_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω");
          const state = await apiPost("/join", { chat_id: Number(chatId), init_data: tg.initData });
          renderState(state);
          joinBtn.disabled = true;
          joinBtn.textContent = "‚úî –í—ã –≤ –∏–≥—Ä–µ";
        } catch (e) {
          alert("‚ùå Join: " + e.message);
        }
      };

      leaveBtn.onclick = async () => {
        try {
          if (!chatId) return alert("‚ùå chat_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω");
          const state = await apiPost("/leave", { chat_id: Number(chatId), init_data: tg.initData });
          renderState(state);
          joinBtn.disabled = false;
          joinBtn.textContent = "‚úÖ Join";
        } catch (e) {
          alert("‚ùå Leave: " + e.message);
        }
      };

      refreshBtn.onclick = refreshState;

      meBtn.onclick = async () => {
        try {
          if (!chatId) return alert("‚ùå chat_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω");
          const r = await apiPost("/me", { chat_id: Number(chatId), init_data: tg.initData });
          const role = r.me?.role;
          if (!role) return alert("–†–æ–ª—å –µ—â—ë –Ω–µ –≤—ã–¥–∞–Ω–∞ (–Ω–∞–∂–º–∏—Ç–µ Start).");
          alert("–í–∞—à–∞ —Ä–æ–ª—å: " + role);
        } catch (e) {
          alert("‚ùå Me: " + e.message);
        }
      };

      saveConfigBtn.onclick = async () => {
        try {
          if (!chatId) return alert("‚ùå chat_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω");
          const cfg = {
            min_players: Number(minPlayersEl.value),
            day_seconds: Number(daySecondsEl.value),
            night_seconds: Number(nightSecondsEl.value),
            roles: {
              mafia: Number(roleMafiaEl.value),
              doctor: Number(roleDoctorEl.value),
              sheriff: Number(roleSheriffEl.value)
            }
          };
          const state = await apiPost("/config", { chat_id: Number(chatId), init_data: tg.initData, config: cfg });
          renderState(state);
          alert("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
        } catch (e) {
          alert("‚ùå Config: " + e.message);
        }
      };

      startGameBtn.onclick = async () => {
        try {
          if (!chatId) return alert("‚ùå chat_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω");
          const state = await apiPost("/start", { chat_id: Number(chatId), init_data: tg.initData });
          renderState(state);
          alert("üé≠ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –ù–æ—á—å.");
        } catch (e) {
          alert("‚ùå Start: " + e.message);
        }
      };

      // –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑ –≤ 3 —Å–µ–∫—É–Ω–¥—ã (—á—Ç–æ–±—ã –≤—Å–µ–º –æ–±–Ω–æ–≤–ª—è–ª–æ—Å—å —Å–∞–º–æ)
      setInterval(refreshState, 3000);

      refreshState();
    }
  </script>
</body>
</html>