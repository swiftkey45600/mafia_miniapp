<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mafia Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body style="font-family: system-ui; padding: 16px; background:#f7f7f7;">
  <h2>üé≠ –ú–∞—Ñ–∏—è</h2>

  <div id="status" style="padding:12px; border-radius:10px; background:#fff; margin-bottom:12px;">
    –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶
  </div>

  <button id="join" style="padding:12px 16px; font-size:16px; width:100%; margin-bottom:12px;">
    ‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ
  </button>

  <div id="playersBox" style="padding:12px; border-radius:10px; background:#fff;">
    <b>–ò–≥—Ä–æ–∫–∏:</b>
    <div id="playersList" style="margin-top:8px; color:#444;">
      –ø–æ–∫–∞ –Ω–∏–∫–æ–≥–æ
    </div>
  </div>

  <script>
    const API_URL = "https://liplike-hominine-zara.ngrok-free.dev";

    const statusEl = document.getElementById("status");
    const joinBtn = document.getElementById("join");
    const playersListEl = document.getElementById("playersList");

    const tg = window.Telegram?.WebApp;

    if (!tg) {
      statusEl.innerHTML = "‚ùå –û—Ç–∫—Ä–æ–π —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ Telegram.";
      joinBtn.disabled = true;
    } else {
      tg.ready();
      tg.expand();

      const chatId = tg.initDataUnsafe?.start_param;
      const user = tg.initDataUnsafe?.user;

      statusEl.innerHTML = `
        <b>–ò–≥—Ä–∞:</b> ${chatId}<br/>
        <b>–í—ã:</b> ${user ? user.first_name : "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}
      `;

      async function refreshPlayers() {
        if (!chatId) return;

        const res = await fetch(`${API_URL}/state?chat_id=${Number(chatId)}`);
        const data = await res.json();

        if (!data.players || data.players.length === 0) {
          playersListEl.innerHTML = "<i>–Ω–∏–∫–æ–≥–æ –Ω–µ—Ç</i>";
          return;
        }

        playersListEl.innerHTML = data.players
          .map(p => `‚Ä¢ ${p.name}`)
          .join("<br/>");
      }

      joinBtn.onclick = async () => {
        if (!chatId) {
          alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–≥—Ä—É");
          return;
        }

        const res = await fetch(`${API_URL}/join`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            chat_id: Number(chatId),
            init_data: tg.initData
          })
        });

        if (!res.ok) {
          alert("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É");
          return;
        }

        await refreshPlayers();
        joinBtn.disabled = true;
        joinBtn.innerText = "‚úî –í—ã –≤ –∏–≥—Ä–µ";
      };

      refreshPlayers();
    }
  </script>
</body>
</html>