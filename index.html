<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mafia Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{ --bg:#0b0f14; --card:#121826; --text:#e6edf3; --muted:#9aa4b2; --border:rgba(255,255,255,.10);
      --primary:#4da3ff; --danger:#ff5d5d; --ok:#2ecc71; --chip:#1b2333; --shadow: 0 10px 30px rgba(0,0,0,.25); --radius:16px; }
    :root.light{ --bg:#f6f7fb; --card:#ffffff; --text:#0b1220; --muted:#5b6472; --border:rgba(10,15,20,.10);
      --primary:#2f7dff; --danger:#e54848; --ok:#1f9d57; --chip:#f0f3f8; --shadow: 0 10px 30px rgba(12,20,33,.10); }
    *{ box-sizing:border-box; }
    body{ margin:0; padding:16px 16px calc(16px + env(safe-area-inset-bottom));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg); color: var(--text); }
    .wrap{ max-width: 520px; margin: 0 auto; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; margin-bottom: 12px; }
    .title{ font-size: 18px; font-weight: 800; display:flex; gap:10px; align-items:center; }
    .badge{ font-size:12px; padding:6px 10px; border-radius:999px; background: var(--chip); border: 1px solid var(--border); color: var(--muted); }
    .card{ background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; box-shadow: var(--shadow); }
    .card + .card{ margin-top: 12px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row.space{ justify-content:space-between; }
    .muted{ color: var(--muted); }
    .small{ font-size: 12px; }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background: var(--chip); border:1px solid var(--border); color: var(--text); font-size: 12px; }
    .dot{ width:8px; height:8px; border-radius:50%; background: var(--muted); }
    .dot.ok{ background: var(--ok); }
    .dot.primary{ background: var(--primary); }
    .dot.danger{ background: var(--danger); }
    .btnbar{ display:flex; gap:10px; }
    .btn{ width:100%; border:1px solid var(--border); background: rgba(255,255,255,.04); color: var(--text);
      border-radius: 14px; padding: 12px 14px; font-weight: 800; font-size: 15px; cursor:pointer;
      user-select:none; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    .btn:active{ transform: scale(.99); }
    .btn[disabled]{ opacity: .55; cursor:not-allowed; }
    .btn.primary{ background: color-mix(in srgb, var(--primary) 20%, transparent); border-color: color-mix(in srgb, var(--primary) 40%, var(--border)); }
    .btn.danger{ background: color-mix(in srgb, var(--danger) 18%, transparent); border-color: color-mix(in srgb, var(--danger) 40%, var(--border)); }
    .btn.smallBtn{ padding:8px 10px; font-size: 13px; width:auto; }
    .list{ margin-top: 10px; display:flex; flex-direction:column; gap:8px; }
    .item{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border:1px solid var(--border); border-radius: 14px; background: rgba(255,255,255,.03); gap:10px; }
    .item .name{ font-weight: 800; }
    .item .sub{ color: var(--muted); font-size: 12px; margin-top: 2px; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input{ width:100%; padding: 12px 12px; border-radius: 14px; border: 1px solid var(--border); background: rgba(255,255,255,.04);
      color: var(--text); font-size: 16px; outline: none; }
    input:focus{ border-color: color-mix(in srgb, var(--primary) 55%, var(--border)); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 18%, transparent); }
    .sectionTitle{ font-weight: 900; display:flex; align-items:center; justify-content:space-between; margin-bottom: 8px; }
    .hint{ margin-top: 8px; font-size: 12px; color: var(--muted); line-height: 1.35; }
    .toast{ position: fixed; left: 16px; right: 16px; bottom: calc(16px + env(safe-area-inset-bottom)); max-width: 520px; margin: 0 auto;
      background: var(--card); border:1px solid var(--border); border-radius: 14px; padding: 12px 14px; box-shadow: var(--shadow);
      display:none; font-size: 13px; z-index: 9999; }
    .hidden{ display:none !important; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">üé≠ Mafia <span class="badge" id="phaseBadge">Lobby</span></div>
    <div class="badge" id="timerBadge">‚Äî</div>
  </div>

  <div class="card">
    <div class="row space">
      <div>
        <div style="font-weight:900; font-size:15px;" id="gameLine">–ò–≥—Ä–∞</div>
        <div class="small muted" id="youLine">–í—ã</div>
      </div>
      <div class="chip" id="hostChip">
        <span class="dot"></span>
        <span id="hostText">Host: ‚Äî</span>
      </div>
    </div>

    <div style="height:10px"></div>

    <div class="btnbar">
      <button class="btn primary" id="joinBtn">Join</button>
      <button class="btn danger hidden" id="leaveBtn">Leave</button>
    </div>

    <div style="height:10px"></div>

    <div class="btnbar">
      <button class="btn" id="roleBtn">–ú–æ—è —Ä–æ–ª—å</button>
      <button class="btn" id="syncBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div class="hint" id="statusHint"></div>
    <div class="hint small" id="debugLine"></div>
  </div>

  <div class="card hidden" id="hostPanel">
    <div class="sectionTitle">
      <span>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã</span>
      <span class="badge" id="versionBadge">v8</span>
    </div>

    <div class="grid">
      <div>
        <label>–ú–∏–Ω. –∏–≥—Ä–æ–∫–æ–≤</label>
        <input id="minPlayers" type="number" min="3" value="3" inputmode="numeric" />
      </div>
      <div>
        <label>–î–µ–Ω—å (—Å–µ–∫)</label>
        <input id="daySeconds" type="number" min="10" value="60" inputmode="numeric" />
      </div>
      <div>
        <label>–ù–æ—á—å (—Å–µ–∫)</label>
        <input id="nightSeconds" type="number" min="10" value="45" inputmode="numeric" />
      </div>
      <div>
        <label>‚Äî</label>
        <div class="chip"><span class="dot primary"></span><span>–†–æ–ª–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –Ω–∏–∂–µ</span></div>
      </div>
    </div>

    <div style="height:10px"></div>
    <div class="sectionTitle"><span>üé≠ –†–æ–ª–∏ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)</span><span class="badge">custom</span></div>

    <div class="grid">
      <div><label>–ú–∞—Ñ–∏—è</label><input id="roleMafia" type="number" min="0" value="1" inputmode="numeric" /></div>
      <div><label>–î–æ–Ω</label><input id="roleDon" type="number" min="0" value="0" inputmode="numeric" /></div>

      <div><label>–®–µ—Ä–∏—Ñ</label><input id="roleSheriff" type="number" min="0" value="1" inputmode="numeric" /></div>
      <div><label>–î–æ–∫—Ç–æ—Ä</label><input id="roleDoctor" type="number" min="0" value="0" inputmode="numeric" /></div>

      <div><label>–ú–∞–Ω—å—è–∫</label><input id="roleManiac" type="number" min="0" value="0" inputmode="numeric" /></div>
      <div><label>–ù–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞</label><input id="roleButterfly" type="number" min="0" value="0" inputmode="numeric" /></div>
    </div>

    <div style="height:10px"></div>

    <div class="btnbar">
      <button class="btn" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn primary" id="startBtn">Start</button>
    </div>

    <div class="hint" id="hostHint">‚Äî</div>
  </div>

  <div class="card">
    <div class="sectionTitle">
      <span>–ò–≥—Ä–æ–∫–∏</span>
      <span class="chip"><span class="dot ok"></span><span id="playersCount">0</span></span>
    </div>
    <div class="list" id="playersList"></div>
    <div class="hint small">–•–æ—Å—Ç –º–æ–∂–µ—Ç –ø–µ—Ä–µ–¥–∞—Ç—å –ø—Ä–∞–≤–∞ –≤ Lobby (–∫–Ω–æ–ø–∫–∞ ‚ÄúMake host‚Äù).</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const API_URL = "https://liplike-hominine-zara.ngrok-free.dev";
  const NGROK_HEADERS = { "ngrok-skip-browser-warning": "1" };
  const APP_VERSION = "v8";

  const tg = window.Telegram?.WebApp;

  const phaseBadge = document.getElementById("phaseBadge");
  const timerBadge = document.getElementById("timerBadge");

  const gameLine = document.getElementById("gameLine");
  const youLine = document.getElementById("youLine");
  const hostChip = document.getElementById("hostChip");
  const hostText = document.getElementById("hostText");
  const statusHint = document.getElementById("statusHint");
  const debugLine = document.getElementById("debugLine");

  const joinBtn = document.getElementById("joinBtn");
  const leaveBtn = document.getElementById("leaveBtn");
  const roleBtn = document.getElementById("roleBtn");
  const syncBtn = document.getElementById("syncBtn");

  const hostPanel = document.getElementById("hostPanel");
  const hostHint = document.getElementById("hostHint");
  const saveBtn = document.getElementById("saveBtn");
  const startBtn = document.getElementById("startBtn");

  const minPlayersEl = document.getElementById("minPlayers");
  const daySecondsEl = document.getElementById("daySeconds");
  const nightSecondsEl = document.getElementById("nightSeconds");

  const roleMafiaEl = document.getElementById("roleMafia");
  const roleDonEl = document.getElementById("roleDon");
  const roleSheriffEl = document.getElementById("roleSheriff");
  const roleDoctorEl = document.getElementById("roleDoctor");
  const roleManiacEl = document.getElementById("roleManiac");
  const roleButterflyEl = document.getElementById("roleButterfly");

  const playersCount = document.getElementById("playersCount");
  const playersList = document.getElementById("playersList");

  const toast = document.getElementById("toast");

  let timerInterval = null;
  let editingConfig = false;
  let lastState = null;

  function showToast(msg){
    toast.textContent = msg;
    toast.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.style.display="none", 1800);
  }
  function setDebug(msg){ debugLine.textContent = msg ? ("debug: " + msg) : ""; }

  async function runLocked(btn, fn){
    if (btn.dataset.busy === "1") return;
    btn.dataset.busy = "1";
    const oldText = btn.textContent;
    btn.disabled = true;
    try { await fn(); }
    finally {
      btn.disabled = false;
      btn.textContent = oldText;
      btn.dataset.busy = "0";
    }
  }

  function phaseName(p){
    if (p === "lobby") return "Lobby";
    if (p === "night") return "Night";
    if (p === "day") return "Day";
    return p ?? "‚Äî";
  }
  function fmtSeconds(sec){
    sec = Math.max(0, sec|0);
    const m = Math.floor(sec/60);
    const r = sec%60;
    return m>0 ? `${m}:${String(r).padStart(2,"0")}` : String(r);
  }

  function applyTelegramTheme(){
    const tp = tg?.themeParams || {};
    const bg = tp.bg_color;
    const text = tp.text_color;
    const hint = tp.hint_color;
    const card = tp.secondary_bg_color;

    const isLight = (() => {
      const c = bg || "#0b0f14";
      const hex = c.replace("#","");
      if (hex.length !== 6) return false;
      const r = parseInt(hex.slice(0,2),16);
      const g = parseInt(hex.slice(2,4),16);
      const b = parseInt(hex.slice(4,6),16);
      const lum = (0.2126*r + 0.7152*g + 0.0722*b);
      return lum > 160;
    })();

    if (isLight) document.documentElement.classList.add("light");
    else document.documentElement.classList.remove("light");

    if (bg) document.documentElement.style.setProperty("--bg", bg);
    if (text) document.documentElement.style.setProperty("--text", text);
    if (hint) document.documentElement.style.setProperty("--muted", hint);
    if (card) document.documentElement.style.setProperty("--card", card);
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function apiGet(path, params={}){
    const u = new URL(path, API_URL);
    for (const [k,v] of Object.entries(params)) u.searchParams.set(k, String(v));
    setDebug(`GET ${u.toString()} | ${APP_VERSION}`);
    const res = await fetch(u.toString(), { method:"GET", headers: NGROK_HEADERS, cache: "no-store" });
    const text = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${text.slice(0,220)}`);
    return JSON.parse(text);
  }

  async function apiPost(path, body){
    const u = new URL(path, API_URL);
    setDebug(`POST ${u.toString()} | ${APP_VERSION}`);
    const res = await fetch(u.toString(), {
      method:"POST",
      headers: { "Content-Type":"application/json", "ngrok-skip-browser-warning":"1" },
      body: JSON.stringify(body),
      cache: "no-store"
    });
    const text = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${text.slice(0,220)}`);
    return JSON.parse(text);
  }

  function setJoinLeaveVisibility(isInGame){
    joinBtn.classList.toggle("hidden", isInGame);
    leaveBtn.classList.toggle("hidden", !isInGame);
  }

  function bindInputEditing(){
    const inputs = [
      minPlayersEl, daySecondsEl, nightSecondsEl,
      roleMafiaEl, roleDonEl, roleSheriffEl, roleDoctorEl, roleManiacEl, roleButterflyEl
    ];
    for (const el of inputs){
      el.addEventListener("input", ()=> { editingConfig = true; });
      el.addEventListener("focus", ()=> { editingConfig = true; });
    }
  }

  function renderPlayers(players, myId, isHost, phase){
    playersCount.textContent = String(players.length);
    playersList.innerHTML = "";

    if (players.length === 0){
      playersList.innerHTML = "<div class='item'><div class='muted'>–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ</div></div>";
      return;
    }

    for (const p of players){
      const left = document.createElement("div");
      left.innerHTML = `
        <div class="name">${escapeHtml(p.name ?? "‚Äî")}</div>
        <div class="sub">${p.alive === false ? "üíÄ –≤—ã–±—ã–ª" : "‚úÖ –≤ –∏–≥—Ä–µ"}</div>
      `;

      const right = document.createElement("div");
      right.className = "row";
      right.style.gap = "8px";

      const roleChip = document.createElement("div");
      roleChip.className = "chip";
      roleChip.innerHTML = `<span class="dot ${p.role ? "primary" : ""}"></span><span>${p.role ? "—Ä–æ–ª—å –µ—Å—Ç—å" : "—Ä–æ–ª—å –Ω–µ—Ç"}</span>`;
      right.appendChild(roleChip);

      // ‚úÖ Transfer host —Ç–æ–ª—å–∫–æ: host -> –≤ lobby -> –Ω–µ –Ω–∞ —Å–µ–±—è
      if (isHost && phase === "lobby" && p.id !== myId){
        const btn = document.createElement("button");
        btn.className = "btn smallBtn";
        btn.textContent = "Make host";
        btn.onclick = () => runLocked(btn, async ()=>{
          const st = await apiPost("/transfer_host", { chat_id: Number(window.__chatId), init_data: tg.initData, target_user_id: p.id });
          renderState(st, myId);
          showToast("Host –ø–µ—Ä–µ–¥–∞–Ω");
        });
        right.appendChild(btn);
      }

      const item = document.createElement("div");
      item.className = "item";
      item.appendChild(left);
      item.appendChild(right);
      playersList.appendChild(item);
    }
  }

  function renderState(state, myId){
    lastState = state;

    const phase = state.phase;
    phaseBadge.textContent = phaseName(phase);

    const isHost = (state.host_id && myId && state.host_id === myId);
    hostPanel.classList.toggle("hidden", !isHost);

    hostText.textContent = "Host: " + (state.host_id ?? "‚Äî");
    hostChip.querySelector(".dot").className = "dot " + (isHost ? "ok" : "");

    startBtn.disabled = !(isHost && phase === "lobby");

    const cfg = state.config;
    if (cfg && !editingConfig){
      minPlayersEl.value = cfg.min_players;
      daySecondsEl.value = cfg.day_seconds;
      nightSecondsEl.value = cfg.night_seconds;

      roleMafiaEl.value = cfg.roles.mafia ?? 0;
      roleDonEl.value = cfg.roles.don ?? 0;
      roleSheriffEl.value = cfg.roles.sheriff ?? 0;
      roleDoctorEl.value = cfg.roles.doctor ?? 0;
      roleManiacEl.value = cfg.roles.maniac ?? 0;
      roleButterflyEl.value = cfg.roles.butterfly ?? 0;
    }

    const endsAt = state.phase_ends_at;
    if (timerInterval) clearInterval(timerInterval);
    if (endsAt){
      timerInterval = setInterval(()=>{
        const sec = Math.max(0, Math.floor(endsAt*1000 - Date.now())/1000);
        timerBadge.textContent = "‚è≥ " + fmtSeconds(sec);
        if (sec <= 0) refreshState();
      }, 500);
    } else {
      timerBadge.textContent = (phase === "lobby") ? "‚è∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞" : "‚Ä¶";
    }

    const players = state.players ?? [];
    const isInGame = !!players.find(p => p.id === myId);
    setJoinLeaveVisibility(isInGame);

    statusHint.textContent = (phase === "lobby")
      ? "–°–æ–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–æ–≤, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–æ–ª–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ Start (—Ö–æ—Å—Ç)."
      : "–ò–≥—Ä–∞ –∏–¥—ë—Ç. –§–∞–∑—ã –º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.";

    const rolesTotal =
      (Number(roleMafiaEl.value)||0)+(Number(roleDonEl.value)||0)+(Number(roleSheriffEl.value)||0)+
      (Number(roleDoctorEl.value)||0)+(Number(roleManiacEl.value)||0)+(Number(roleButterflyEl.value)||0);

    if (isHost){
      hostHint.textContent = `–ò–≥—Ä–æ–∫–æ–≤: ${players.length}. –°–ø–µ—Ü-—Ä–æ–ª–µ–π: ${rolesTotal}. –û—Å—Ç–∞–ª—å–Ω—ã–µ –±—É–¥—É—Ç –º–∏—Ä–Ω—ã–º–∏. –í–µ—Ä—Å–∏—è: ${APP_VERSION}.`;
    }

    renderPlayers(players, myId, isHost, phase);
  }

  async function refreshState(){
    if (!window.__chatId) return;
    try{
      const st = await apiGet("/state", { chat_id: window.__chatId });
      renderState(st, window.__myId);
    } catch(e){
      showToast("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
      setDebug("refresh error: " + e.message);
    }
  }

  if (!tg){
    document.body.innerHTML = "<div class='wrap'><div class='card'>‚ùå –û—Ç–∫—Ä–æ–π Mini App —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ Telegram.</div></div>";
  } else {
    tg.ready();
    tg.expand();
    applyTelegramTheme();

    const chatId = tg.initDataUnsafe?.start_param;
    const meUser = tg.initDataUnsafe?.user;
    const myId = meUser?.id;

    window.__chatId = chatId;
    window.__myId = myId;

    gameLine.textContent = `–ò–≥—Ä–∞: ${chatId ?? "‚Äî"}`;
    youLine.textContent = `–í—ã: ${meUser ? meUser.first_name : "‚Äî"} (${myId ?? "‚Äî"})`;

    bindInputEditing();

    joinBtn.onclick = () => runLocked(joinBtn, async ()=>{
      const st = await apiPost("/join", { chat_id: Number(chatId), init_data: tg.initData });
      editingConfig = false;
      renderState(st, myId);
      showToast("–í—ã –≤ –∏–≥—Ä–µ");
    });

    leaveBtn.onclick = () => runLocked(leaveBtn, async ()=>{
      const st = await apiPost("/leave", { chat_id: Number(chatId), init_data: tg.initData });
      editingConfig = false;
      renderState(st, myId);
      showToast("–í—ã –≤—ã—à–ª–∏");
    });

    roleBtn.onclick = () => runLocked(roleBtn, async ()=>{
      const r = await apiPost("/me", { chat_id: Number(chatId), init_data: tg.initData });
      const role = r.me?.role_label || r.me?.role;
      showToast(role ? ("–í–∞—à–∞ —Ä–æ–ª—å: " + role) : "–†–æ–ª—å –µ—â—ë –Ω–µ –≤—ã–¥–∞–Ω–∞");
    });

    syncBtn.onclick = () => runLocked(syncBtn, async ()=>{
      await refreshState();
      showToast("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ");
    });

    saveBtn.onclick = () => runLocked(saveBtn, async ()=>{
      const cfg = {
        min_players: Number(minPlayersEl.value),
        day_seconds: Number(daySecondsEl.value),
        night_seconds: Number(nightSecondsEl.value),
        roles: {
          mafia: Number(roleMafiaEl.value),
          don: Number(roleDonEl.value),
          sheriff: Number(roleSheriffEl.value),
          doctor: Number(roleDoctorEl.value),
          maniac: Number(roleManiacEl.value),
          butterfly: Number(roleButterflyEl.value),
        }
      };
      const st = await apiPost("/config", { chat_id: Number(chatId), init_data: tg.initData, config: cfg });
      editingConfig = false;
      renderState(st, myId);
      showToast("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
    });

    startBtn.onclick = () => runLocked(startBtn, async ()=>{
      const st = await apiPost("/start", { chat_id: Number(chatId), init_data: tg.initData });
      editingConfig = false;
      renderState(st, myId);
      showToast("–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å");
    });

    setInterval(refreshState, 3000);
    refreshState();
  }
</script>
</body>
</html>